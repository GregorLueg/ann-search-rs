## GPU-accelerated indices benchmarks and parameter gridsearch

Below are benchmarks shown for the GPU-accelerated code. If you wish to run
the example script, please use:

```bash
cargo run --example gridsearch_gpu --features gpu --release
```

To run all of the benchmarks, you can just run:

```bash
bash examples/run_benchmarks.sh --gpu
```

Similar to the other benchmarks, index building, query against 10% slightly
different data based on the trainings data and full kNN generation is being
benchmarked. Index size in memory is also provided.

## Table of Contents

- [Comparison against CPU exhaustive](#comparison-against-cpu-exhaustive)
- [Comparison against CPU IVF (small dataset)](#with-250k-samples-and-64-dimensions)
- [Comparison against CPU IVF (large dataset)](#with-250k-samples-and-64-dimensions)

### Comparison against CPU exhaustive

The GPU acceleration is notable already in the exhaustive index. The IVF-GPU
reaches very fast speeds here, but not much faster actually than the IVF-CPU
version (or exhaustive GPU index). The advantages for the IVF-GPU index become
more apparent in larger data sets (more to that below). Also to note is that
the data is kept on the GPU for easier access and less frequent transfer between
CPU and GPU. 

<details>
<summary><b>GPU - Euclidean (Gaussian)</b>:</summary>
<pre><code>
================================================================================================================================
Benchmark: 150k cells, 32D (CPU vs GPU Exhaustive vs IVF-GPU)
================================================================================================================================
Method                                               Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
--------------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                         3.36     1_584.92     1_588.27       1.0000     0.000000        18.31
Exhaustive (self)                                          3.36    17_573.03    17_576.38       1.0000     0.000000        18.31
--------------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                     3.64       706.01       709.64       1.0000    42.239541        18.31
GPU-Exhaustive (self)                                      3.64     5_923.93     5_927.57       1.0000    41.895961        18.31
--------------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl273-np13 (query)                               875.23       653.53     1_528.75       0.9889     0.034509         1.15
IVF-GPU-nl273-np16 (query)                               875.23       677.14     1_552.36       0.9967     0.006517         1.15
IVF-GPU-nl273-np23 (query)                               875.23       642.95     1_518.18       1.0000     0.000003         1.15
IVF-GPU-nl273 (self)                                     875.23     5_443.99     6_319.22       1.0000     0.000003         1.15
IVF-GPU-nl387-np19 (query)                             1_293.10       521.84     1_814.94       0.9926     0.031031         1.15
IVF-GPU-nl387-np27 (query)                             1_293.10       665.12     1_958.22       0.9998     0.000650         1.15
IVF-GPU-nl387 (self)                                   1_293.10     3_505.50     4_798.60       0.9998     0.000681         1.15
IVF-GPU-nl547-np23 (query)                             2_333.79       533.86     2_867.64       0.9882     0.041947         1.15
IVF-GPU-nl547-np27 (query)                             2_333.79       532.96     2_866.75       0.9958     0.014728         1.15
IVF-GPU-nl547-np33 (query)                             2_333.79       592.88     2_926.67       0.9997     0.001039         1.15
IVF-GPU-nl547 (self)                                   2_333.79     3_246.57     5_580.36       0.9997     0.001006         1.15
--------------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

<details>
<summary><b>GPU - Cosine (Gaussian)</b>:</summary>
<pre><code>
================================================================================================================================
Benchmark: 150k cells, 32D (CPU vs GPU Exhaustive vs IVF-GPU)
================================================================================================================================
Benchmark: 150k cells, 32D (CPU vs GPU Exhaustive vs IVF-GPU)
================================================================================================================================
Method                                               Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
--------------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                         4.22     1_558.43     1_562.65       1.0000     0.000000        18.88
Exhaustive (self)                                          4.22    17_333.38    17_337.60       1.0000     0.000000        18.88
--------------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                     4.44       682.30       686.73       1.0000     0.030828        18.88
GPU-Exhaustive (self)                                      4.44     5_956.40     5_960.84       1.0000     0.030637        18.88
--------------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl273-np13 (query)                               886.70       705.71     1_592.42       0.9893     0.000025         1.15
IVF-GPU-nl273-np16 (query)                               886.70       588.77     1_475.48       0.9970     0.000005         1.15
IVF-GPU-nl273-np23 (query)                               886.70       755.59     1_642.30       1.0000     0.000000         1.15
IVF-GPU-nl273 (self)                                     886.70     5_198.11     6_084.81       1.0000     0.000000         1.15
IVF-GPU-nl387-np19 (query)                             1_226.72       508.92     1_735.63       0.9929     0.000019         1.15
IVF-GPU-nl387-np27 (query)                             1_226.72       619.54     1_846.26       0.9998     0.000000         1.15
IVF-GPU-nl387 (self)                                   1_226.72     3_244.48     4_471.20       0.9998     0.000000         1.15
IVF-GPU-nl547-np23 (query)                             1_696.00       518.63     2_214.63       0.9890     0.000026         1.15
IVF-GPU-nl547-np27 (query)                             1_696.00       483.47     2_179.47       0.9963     0.000008         1.15
IVF-GPU-nl547-np33 (query)                             1_696.00       544.46     2_240.46       0.9997     0.000001         1.15
IVF-GPU-nl547 (self)                                   1_696.00     2_980.22     4_676.22       0.9997     0.000001         1.15
--------------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

<details>
<summary><b>GPU - Euclidean (Correlated)</b>:</summary>
<pre><code>
================================================================================================================================
Benchmark: 150k cells, 32D (CPU vs GPU Exhaustive vs IVF-GPU)
================================================================================================================================
Method                                               Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
--------------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                         3.16     1_536.24     1_539.40       1.0000     0.000000        18.31
Exhaustive (self)                                          3.16    16_594.43    16_597.59       1.0000     0.000000        18.31
--------------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                     3.41       715.51       718.93       1.0000     2.406931        18.31
GPU-Exhaustive (self)                                      3.41     5_904.92     5_908.34       1.0000     2.415342        18.31
--------------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl273-np13 (query)                               949.54       521.04     1_470.59       0.9998     0.000027         1.15
IVF-GPU-nl273-np16 (query)                               949.54       585.13     1_534.68       1.0000     0.000006         1.15
IVF-GPU-nl273-np23 (query)                               949.54       694.35     1_643.89       1.0000     0.000000         1.15
IVF-GPU-nl273 (self)                                     949.54     3_716.46     4_666.00       1.0000     0.000000         1.15
IVF-GPU-nl387-np19 (query)                             1_383.20       482.92     1_866.12       0.9999     0.000014         1.15
IVF-GPU-nl387-np27 (query)                             1_383.20       616.95     2_000.16       1.0000     0.000000         1.15
IVF-GPU-nl387 (self)                                   1_383.20     3_015.28     4_398.48       1.0000     0.000000         1.15
IVF-GPU-nl547-np23 (query)                             1_734.94       355.80     2_090.75       0.9999     0.000021         1.15
IVF-GPU-nl547-np27 (query)                             1_734.94       462.03     2_196.97       1.0000     0.000010         1.15
IVF-GPU-nl547-np33 (query)                             1_734.94       540.85     2_275.79       1.0000     0.000000         1.15
IVF-GPU-nl547 (self)                                   1_734.94     2_825.43     4_560.37       1.0000     0.000003         1.15
--------------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

<details>
<summary><b>GPU - Euclidean (LowRank)</b>:</summary>
<pre><code>
================================================================================================================================
Benchmark: 150k cells, 32D (CPU vs GPU Exhaustive vs IVF-GPU)
================================================================================================================================
Method                                               Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
--------------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                         3.05     1_542.41     1_545.46       1.0000     0.000000        18.31
Exhaustive (self)                                          3.05    16_395.20    16_398.25       1.0000     0.000000        18.31
--------------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                     3.84       702.22       706.06       1.0000     8.879391        18.31
GPU-Exhaustive (self)                                      3.84     5_927.00     5_930.84       1.0000     8.901199        18.31
--------------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl273-np13 (query)                               954.46       575.31     1_529.77       1.0000     0.000015         1.15
IVF-GPU-nl273-np16 (query)                               954.46       650.02     1_604.49       1.0000     0.000001         1.15
IVF-GPU-nl273-np23 (query)                               954.46       693.69     1_648.16       1.0000     0.000001         1.15
IVF-GPU-nl273 (self)                                     954.46     3_452.06     4_406.52       1.0000     0.000001         1.15
IVF-GPU-nl387-np19 (query)                             1_488.86       522.28     2_011.13       1.0000     0.000001         1.15
IVF-GPU-nl387-np27 (query)                             1_488.86       681.30     2_170.15       1.0000     0.000001         1.15
IVF-GPU-nl387 (self)                                   1_488.86     3_343.45     4_832.31       1.0000     0.000001         1.15
IVF-GPU-nl547-np23 (query)                             1_888.91       388.90     2_277.81       1.0000     0.000001         1.15
IVF-GPU-nl547-np27 (query)                             1_888.91       484.01     2_372.92       1.0000     0.000001         1.15
IVF-GPU-nl547-np33 (query)                             1_888.91       590.99     2_479.90       1.0000     0.000001         1.15
IVF-GPU-nl547 (self)                                   1_888.91     3_189.26     5_078.17       1.0000     0.000001         1.15
--------------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

### Comparison against IVF CPU

In this case, the IVF CPU implementation is being compared against the GPU 
version. GPU acceleration shines with larger data sets and larger dimensions, 
hence, the number of samples was increased to 250_000 and dimensions to 64 for 
these benchmarks.

#### With 250k samples and 64 dimensions

<details>
<summary><b>CPU-IVF (medium dataset)</b>:</summary>
<pre><code>
================================================================================================================================
Benchmark: 250k cells, 64D
================================================================================================================================
Method                                               Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
--------------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                        11.47     5_909.21     5_920.68       1.0000     0.000000        61.04
Exhaustive (self)                                         11.47    98_482.16    98_493.64       1.0000     0.000000        61.04
--------------------------------------------------------------------------------------------------------------------------------
IVF-nl353-np17 (query)                                 3_416.55     1_111.59     4_528.13       0.9864     0.155719        63.03
IVF-nl353-np18 (query)                                 3_416.55     1_099.11     4_515.65       0.9916     0.094313        63.03
IVF-nl353-np26 (query)                                 3_416.55     1_738.11     5_154.66       1.0000     0.000000        63.03
IVF-nl353 (self)                                       3_416.55    24_032.02    27_448.57       1.0000     0.000000        63.03
IVF-nl500-np22 (query)                                 5_416.18       820.04     6_236.22       0.9849     0.144415        63.07
IVF-nl500-np25 (query)                                 5_416.18       988.36     6_404.54       0.9963     0.036957        63.07
IVF-nl500-np31 (query)                                 5_416.18     1_232.99     6_649.17       1.0000     0.000000        63.07
IVF-nl500 (self)                                       5_416.18    22_021.14    27_437.33       1.0000     0.000000        63.07
IVF-nl707-np26 (query)                                 7_006.70     1_146.64     8_153.34       0.9588     0.409737        63.12
IVF-nl707-np35 (query)                                 7_006.70     1_636.79     8_643.48       0.9956     0.040787        63.12
IVF-nl707-np37 (query)                                 7_006.70       895.99     7_902.69       0.9981     0.017126        63.12
IVF-nl707 (self)                                       7_006.70    15_685.21    22_691.91       0.9983     0.016073        63.12
--------------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

<details>
<summary><b>GPU-IVF (medium dataset)</b>:</summary>
<pre><code>
================================================================================================================================
Benchmark: 250k cells, 64D (CPU vs GPU Exhaustive vs IVF-GPU)
================================================================================================================================
Method                                               Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
--------------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                        12.21     6_619.84     6_632.05       1.0000     0.000000        61.04
Exhaustive (self)                                         12.21    95_301.90    95_314.12       1.0000     0.000000        61.04
--------------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                    11.82     1_458.33     1_470.16       1.0000   176.188002        61.04
GPU-Exhaustive (self)                                     11.82    22_449.04    22_460.87       1.0000   176.720169        61.04
--------------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl353-np17 (query)                             3_059.79       794.98     3_854.77       0.9864     0.155757         1.91
IVF-GPU-nl353-np18 (query)                             3_059.79       718.82     3_778.61       0.9916     0.094331         1.91
IVF-GPU-nl353-np26 (query)                             3_059.79       884.93     3_944.71       1.0000     0.000019         1.91
IVF-GPU-nl353 (self)                                   3_059.79     8_620.98    11_680.77       1.0000     0.000019         1.91
IVF-GPU-nl500-np22 (query)                             4_190.54       669.75     4_860.29       0.9848     0.145574         1.91
IVF-GPU-nl500-np25 (query)                             4_190.54       713.07     4_903.61       0.9962     0.037150         1.91
IVF-GPU-nl500-np31 (query)                             4_190.54       822.48     5_013.02       1.0000     0.000019         1.91
IVF-GPU-nl500 (self)                                   4_190.54     7_430.45    11_620.99       1.0000     0.000019         1.91
IVF-GPU-nl707-np26 (query)                             6_202.76       638.77     6_841.53       0.9588     0.409751         1.91
IVF-GPU-nl707-np35 (query)                             6_202.76       776.68     6_979.43       0.9956     0.040805         1.91
IVF-GPU-nl707-np37 (query)                             6_202.76       799.27     7_002.03       0.9981     0.017145         1.91
IVF-GPU-nl707 (self)                                   6_202.76     7_071.86    13_274.62       0.9983     0.016091         1.91
--------------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

The results here are more favourable of the GPU acceleration. We go from ~100
seconds with exhaustive search on CPU to ~25 seconds on GPU; if using IVF, we
can reduce at the fastest settings the time from ~25 seconds on CPU to ~12 
seconds on GPU. This gives us a total acceleration of 
**100 seconds *(exhaustive on CPU)* to 12 seconds *(IVF on GPU)***, a `8x` 
acceleration while having a Recall 1.00. 

#### With 500k samples and 64 dimensions

Results are becoming even more pronounced with more cells and showing the
advantage of the GPU acceleration. 

<details>
<summary><b>CPU-IVF (larger dataset)</b>:</summary>
<pre><code>
================================================================================================================================
Benchmark: 500k cells, 64D
================================================================================================================================
Method                                               Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
--------------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                        22.17    12_430.81    12_452.97       1.0000     0.000000       122.07
Exhaustive (self)                                         22.17   412_309.07   412_331.24       1.0000     0.000000       122.07
--------------------------------------------------------------------------------------------------------------------------------
IVF-nl500-np22 (query)                                 8_256.63     2_006.83    10_263.46       0.9863     0.124157       126.01
IVF-nl500-np25 (query)                                 8_256.63     2_283.59    10_540.23       0.9955     0.041126       126.01
IVF-nl500-np31 (query)                                 8_256.63     2_875.32    11_131.95       0.9997     0.003379       126.01
IVF-nl500 (self)                                       8_256.63    94_781.81   103_038.45       0.9996     0.003637       126.01
IVF-nl707-np26 (query)                                13_022.88     1_719.03    14_741.91       0.9664     0.279934       126.06
IVF-nl707-np35 (query)                                13_022.88     2_244.57    15_267.44       0.9961     0.020209       126.06
IVF-nl707-np37 (query)                                13_022.88     2_365.35    15_388.23       0.9982     0.007073       126.06
IVF-nl707 (self)                                      13_022.88    78_831.29    91_854.16       0.9981     0.007456       126.06
IVF-nl1000-np31 (query)                               18_226.20     1_402.45    19_628.65       0.9386     0.550040       126.14
IVF-nl1000-np44 (query)                               18_226.20     1_949.22    20_175.42       0.9897     0.071157       126.14
IVF-nl1000-np50 (query)                               18_226.20     2_294.51    20_520.70       0.9968     0.017910       126.14
IVF-nl1000 (self)                                     18_226.20    70_215.86    88_442.06       0.9896     0.073848       126.14
--------------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

<details>
<summary><b>GPU-IVF (larger dataset)</b>:</summary>
<pre><code>
================================================================================================================================
Benchmark: 500k cells, 64D (CPU vs GPU Exhaustive vs IVF-GPU)
================================================================================================================================
Method                                               Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
--------------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                        20.86    11_208.54    11_229.40       1.0000     0.000000       122.07
Exhaustive (self)                                         20.86   386_837.05   386_857.91       1.0000     0.000000       122.07
--------------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                    20.79     2_759.55     2_780.34       1.0000   176.771542       122.07
GPU-Exhaustive (self)                                     20.79    87_586.32    87_607.12       1.0000   175.738638       122.07
--------------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl500-np22 (query)                             9_494.95     1_075.84    10_570.79       0.9862     0.124562         3.82
IVF-GPU-nl500-np25 (query)                             9_494.95       994.58    10_489.53       0.9954     0.041181         3.82
IVF-GPU-nl500-np31 (query)                             9_494.95     1_680.21    11_175.16       0.9997     0.003398         3.82
IVF-GPU-nl500 (self)                                   9_494.95    28_240.72    37_735.67       0.9996     0.003655         3.82
IVF-GPU-nl707-np26 (query)                            12_769.11       864.82    13_633.92       0.9663     0.280070         3.82
IVF-GPU-nl707-np35 (query)                            12_769.11       996.77    13_765.88       0.9960     0.020191         3.82
IVF-GPU-nl707-np37 (query)                            12_769.11       990.15    13_759.26       0.9982     0.006968         3.82
IVF-GPU-nl707 (self)                                  12_769.11    23_141.89    35_911.00       0.9981     0.007474         3.82
IVF-GPU-nl1000-np31 (query)                           18_452.14       893.40    19_345.54       0.9389     0.548828         3.82
IVF-GPU-nl1000-np44 (query)                           18_452.14       991.83    19_443.98       0.9898     0.071387         3.82
IVF-GPU-nl1000-np50 (query)                           18_452.14     1_030.58    19_482.72       0.9969     0.017930         3.82
IVF-GPU-nl1000 (self)                                 18_452.14    20_401.10    38_853.25       0.9896     0.073758         3.82
--------------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

In this configuration, the exhaustive CPU to GPU already causes a massive 
reduction in the generation of the full kNN. From ~7 minutes to ~1.5 minutes. 
However, the true acceleleration comes with the IVF-GPU versions that reduces 
the full kNN generation to a minute, close to 30 seconds. While the index
building takes some time, the subsequent query speed is superb.

#### High dimensionality

With even higher dimensionality, we can observe the advantage of the 
GPU-accelerated versions. Particularly, the difference in the exhaustive search 
is already very impressive with a nearly 5x increase in querying speed. 
Basically, the more dimensions you are dealing with, the better the GPU 
acceleration works.

<details>
<summary><b>GPU with high dimensionality</b>:</summary>
<pre><code>
================================================================================================================================
Benchmark: 150k cells, 128D (CPU vs GPU Exhaustive vs IVF-GPU)
================================================================================================================================
Method                                               Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
--------------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                        15.26     7_073.83     7_089.08       1.0000     0.000000        73.24
Exhaustive (self)                                         15.26    74_251.50    74_266.76       1.0000     0.000000        73.24
--------------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                    14.73     1_812.60     1_827.33       1.0000    87.761408        73.24
GPU-Exhaustive (self)                                     14.73    16_606.31    16_621.03       1.0000    88.236883        73.24
--------------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl273-np13 (query)                             3_024.29       650.18     3_674.47       0.9934     0.025293         1.15
IVF-GPU-nl273-np16 (query)                             3_024.29       729.37     3_753.67       0.9984     0.006808         1.15
IVF-GPU-nl273-np23 (query)                             3_024.29       765.52     3_789.81       1.0000     0.000014         1.15
IVF-GPU-nl273 (self)                                   3_024.29     4_722.69     7_746.98       1.0000     0.000014         1.15
IVF-GPU-nl387-np19 (query)                             4_254.49       590.82     4_845.31       0.9957     0.015586         1.15
IVF-GPU-nl387-np27 (query)                             4_254.49       679.74     4_934.23       0.9999     0.000509         1.15
IVF-GPU-nl387 (self)                                   4_254.49     4_266.03     8_520.52       0.9999     0.000540         1.15
IVF-GPU-nl547-np23 (query)                             5_758.20       496.61     6_254.80       0.9925     0.024028         1.15
IVF-GPU-nl547-np27 (query)                             5_758.20       593.51     6_351.70       0.9971     0.008616         1.15
IVF-GPU-nl547-np33 (query)                             5_758.20       678.97     6_437.17       0.9996     0.001059         1.15
IVF-GPU-nl547 (self)                                   5_758.20     3_866.02     9_624.22       0.9996     0.001065         1.15
--------------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

*All benchmarks were run on M1 Max MacBook Pro with 64 GB unified memory.*
*The GPU backend was the wgpu backend.*