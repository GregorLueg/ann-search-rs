## GPU-accelerated indices benchmarks and parameter gridsearch

Below are benchmarks shown for the GPU-accelerated code. If you wish to run
the example script, please use:

```bash
cargo run --example gridsearch_gpu --features gpu --release
```

To run all of the benchmarks, you can just run:

```bash
bash examples/run_benchmarks.sh --gpu
```

Similar to the other benchmarks, index building, query against 10% slightly
different data based on the trainings data and full kNN generation is being
benchmarked. Index size in memory is also provided.

## Table of Contents

- [Comparison against CPU exhaustive](#comparison-against-cpu-exhaustive)
- [Comparison against CPU IVF (small dataset)](#with-250k-samples-and-64-dimensions)
- [Comparison against CPU IVF (large dataset)](#with-250k-samples-and-64-dimensions)

### Comparison against CPU exhaustive

The GPU acceleration is notable already in the exhaustive index. The IVF-GPU
reaches very fast speeds here, but not much faster actually than the IVF-CPU
version. Due to the current implementation, there is quite a bit of overhead
in copying data from CPU to GPU during individual kernel launches. The 
advantages of the GPU versions are stronger when querying more samples at
higher dimensionality and more samples, see next section.

<details>
<summary><b>GPU - Euclidean (Gaussian)</b>:</summary>
<pre><code>
===========================================================================================================================
Benchmark: 150k cells, 32D (CPU vs GPU Exhaustive vs IVF-GPU)
===========================================================================================================================
Method                                          Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
---------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                    3.64     2_744.40     2_748.05       1.0000     0.000000        18.31
Exhaustive (self)                                     3.64    27_013.96    27_017.61       1.0000     0.000000        18.31
---------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                3.31     1_881.71     1_885.02       1.0000     0.000001        18.31
GPU-Exhaustive (self)                                 3.31    16_550.27    16_553.58       1.0000     0.000001        18.31
---------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl273-np13 (query)                        1_594.26       492.39     2_086.65       0.9889     0.034524        19.46
IVF-GPU-nl273-np16 (query)                        1_594.26       532.09     2_126.35       0.9967     0.006610        19.46
IVF-GPU-nl273-np23 (query)                        1_594.26       766.07     2_360.34       1.0000     0.000001        19.46
IVF-GPU-nl273 (self)                              1_594.26     4_975.66     6_569.92       1.0000     0.000001        19.46
IVF-GPU-nl387-np19 (query)                        2_027.69       594.08     2_621.77       0.9926     0.031090        19.46
IVF-GPU-nl387-np27 (query)                        2_027.69       693.91     2_721.60       0.9998     0.000654        19.46
IVF-GPU-nl387 (self)                              2_027.69     4_523.42     6_551.12       0.9998     0.000692        19.46
IVF-GPU-nl547-np23 (query)                        2_729.21       635.90     3_365.11       0.9882     0.041945        19.46
IVF-GPU-nl547-np27 (query)                        2_729.21       724.23     3_453.44       0.9958     0.014726        19.46
IVF-GPU-nl547-np33 (query)                        2_729.21       801.50     3_530.71       0.9997     0.001037        19.46
IVF-GPU-nl547 (self)                              2_729.21     4_347.83     7_077.04       0.9997     0.001004        19.46
---------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

<details>
<summary><b>GPU - Cosine (Gaussian)</b>:</summary>
<pre><code>
===========================================================================================================================
Benchmark: 150k cells, 32D (CPU vs GPU Exhaustive vs IVF-GPU)
===========================================================================================================================
Method                                          Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
---------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                    5.14     2_596.78     2_601.92       1.0000     0.000000        18.88
Exhaustive (self)                                     5.14    27_370.55    27_375.68       1.0000     0.000000        18.88
---------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                5.44     1_921.97     1_927.41       1.0000     0.000000        18.88
GPU-Exhaustive (self)                                 5.44    17_148.19    17_153.63       1.0000     0.000000        18.88
---------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl273-np13 (query)                        1_490.53       434.75     1_925.28       0.9894     0.000025        20.03
IVF-GPU-nl273-np16 (query)                        1_490.53       522.48     2_013.01       0.9968     0.000006        20.03
IVF-GPU-nl273-np23 (query)                        1_490.53       731.79     2_222.33       1.0000     0.000000        20.03
IVF-GPU-nl273 (self)                              1_490.53     5_217.41     6_707.94       1.0000     0.000000        20.03
IVF-GPU-nl387-np19 (query)                        2_170.45       553.38     2_723.83       0.9930     0.000019        20.03
IVF-GPU-nl387-np27 (query)                        2_170.45       763.87     2_934.32       0.9998     0.000000        20.03
IVF-GPU-nl387 (self)                              2_170.45     4_570.47     6_740.91       0.9998     0.000000        20.03
IVF-GPU-nl547-np23 (query)                        3_229.23       742.43     3_971.65       0.9890     0.000026        20.03
IVF-GPU-nl547-np27 (query)                        3_229.23       588.14     3_817.36       0.9963     0.000009        20.03
IVF-GPU-nl547-np33 (query)                        3_229.23       888.04     4_117.27       0.9996     0.000001        20.03
IVF-GPU-nl547 (self)                              3_229.23     4_585.43     7_814.65       0.9997     0.000001        20.03
---------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

<details>
<summary><b>GPU - Euclidean (Correlated)</b>:</summary>
<pre><code>
===========================================================================================================================
Benchmark: 150k cells, 32D (CPU vs GPU Exhaustive vs IVF-GPU)
===========================================================================================================================
Method                                          Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
---------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                    4.19     2_692.20     2_696.39       1.0000     0.000000        18.31
Exhaustive (self)                                     4.19    27_053.69    27_057.88       1.0000     0.000000        18.31
---------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                3.52     1_919.81     1_923.33       1.0000     0.000000        18.31
GPU-Exhaustive (self)                                 3.52    16_793.23    16_796.74       1.0000     0.000000        18.31
---------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl273-np13 (query)                        1_400.03       471.65     1_871.67       0.9998     0.000027        19.46
IVF-GPU-nl273-np16 (query)                        1_400.03       525.38     1_925.41       1.0000     0.000005        19.46
IVF-GPU-nl273-np23 (query)                        1_400.03       708.01     2_108.03       1.0000     0.000000        19.46
IVF-GPU-nl273 (self)                              1_400.03     5_083.52     6_483.54       1.0000     0.000000        19.46
IVF-GPU-nl387-np19 (query)                        1_986.36       566.70     2_553.06       0.9999     0.000014        19.46
IVF-GPU-nl387-np27 (query)                        1_986.36       645.36     2_631.72       1.0000     0.000000        19.46
IVF-GPU-nl387 (self)                              1_986.36     4_532.98     6_519.34       1.0000     0.000000        19.46
IVF-GPU-nl547-np23 (query)                        2_886.13       660.70     3_546.83       0.9999     0.000020        19.46
IVF-GPU-nl547-np27 (query)                        2_886.13       676.56     3_562.68       1.0000     0.000009        19.46
IVF-GPU-nl547-np33 (query)                        2_886.13       748.30     3_634.42       1.0000     0.000000        19.46
IVF-GPU-nl547 (self)                              2_886.13     4_343.59     7_229.72       1.0000     0.000003        19.46
---------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

<details>
<summary><b>GPU - Euclidean (LowRank)</b>:</summary>
<pre><code>
===========================================================================================================================
Benchmark: 150k cells, 32D (CPU vs GPU Exhaustive vs IVF-GPU)
===========================================================================================================================
Method                                          Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
---------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                    4.10     2_490.10     2_494.20       1.0000     0.000000        18.31
Exhaustive (self)                                     4.10    25_948.12    25_952.22       1.0000     0.000000        18.31
---------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                                3.61     1_746.36     1_749.96       1.0000     0.000000        18.31
GPU-Exhaustive (self)                                 3.61    16_594.56    16_598.17       1.0000     0.000000        18.31
---------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl273-np13 (query)                        1_646.53       497.65     2_144.18       1.0000     0.000015        19.46
IVF-GPU-nl273-np16 (query)                        1_646.53       531.39     2_177.92       1.0000     0.000000        19.46
IVF-GPU-nl273-np23 (query)                        1_646.53       632.36     2_278.89       1.0000     0.000000        19.46
IVF-GPU-nl273 (self)                              1_646.53     4_740.27     6_386.80       1.0000     0.000000        19.46
IVF-GPU-nl387-np19 (query)                        2_148.91       659.74     2_808.65       1.0000     0.000000        19.46
IVF-GPU-nl387-np27 (query)                        2_148.91       782.01     2_930.92       1.0000     0.000000        19.46
IVF-GPU-nl387 (self)                              2_148.91     4_350.16     6_499.07       1.0000     0.000000        19.46
IVF-GPU-nl547-np23 (query)                        2_912.57       676.45     3_589.03       1.0000     0.000000        19.46
IVF-GPU-nl547-np27 (query)                        2_912.57       624.50     3_537.07       1.0000     0.000000        19.46
IVF-GPU-nl547-np33 (query)                        2_912.57       817.82     3_730.40       1.0000     0.000000        19.46
IVF-GPU-nl547 (self)                              2_912.57     4_442.91     7_355.48       1.0000     0.000000        19.46
---------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

### Comparison against IVF CPU

In this case, the IVF CPU implementation is being compared against the GPU 
version. GPU acceleration shines with larger data sets and larger dimensions, 
hence, the number of samples was increased to 250_000 and dimensions to 64 for 
these benchmarks.

#### With 250k samples and 64 dimensions

<details>
<summary><b>CPU-IVF (medium dataset)</b>:</summary>
<pre><code>
===========================================================================================================================
Benchmark: 250k cells, 64D
===========================================================================================================================
Method                                          Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
---------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                   11.64    11_856.52    11_868.16       1.0000     0.000000        61.04
Exhaustive (self)                                    11.64   190_439.10   190_450.74       1.0000     0.000000        61.04
---------------------------------------------------------------------------------------------------------------------------
IVF-nl353-np17 (query)                            7_760.31     1_569.65     9_329.96       0.9864     0.155917        63.03
IVF-nl353-np18 (query)                            7_760.31     1_771.60     9_531.90       0.9916     0.094062        63.03
IVF-nl353-np26 (query)                            7_760.31     3_242.55    11_002.85       1.0000     0.000000        63.03
IVF-nl353 (self)                                  7_760.31    46_303.21    54_063.52       1.0000     0.000000        63.03
IVF-nl500-np22 (query)                           11_730.99     1_625.27    13_356.26       0.9848     0.145235        63.07
IVF-nl500-np25 (query)                           11_730.99     1_779.24    13_510.23       0.9962     0.036920        63.07
IVF-nl500-np31 (query)                           11_730.99     2_342.93    14_073.92       1.0000     0.000000        63.07
IVF-nl500 (self)                                 11_730.99    39_118.40    50_849.39       1.0000     0.000000        63.07
IVF-nl707-np26 (query)                           15_814.52     1_375.39    17_189.91       0.9588     0.408603        63.12
IVF-nl707-np35 (query)                           15_814.52     1_829.76    17_644.28       0.9956     0.040789        63.12
IVF-nl707-np37 (query)                           15_814.52     1_883.95    17_698.47       0.9981     0.017126        63.12
IVF-nl707 (self)                                 15_814.52    31_243.76    47_058.28       0.9983     0.016073        63.12
---------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

<details>
<summary><b>GPU-IVF (medium dataset)</b>:</summary>
<pre><code>
===========================================================================================================================
Benchmark: 250k cells, 64D (CPU vs GPU Exhaustive vs IVF-GPU)
===========================================================================================================================
Method                                          Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
---------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                   12.18    11_516.75    11_528.94       1.0000     0.000000        61.04
Exhaustive (self)                                    12.18   179_400.05   179_412.23       1.0000     0.000000        61.04
---------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                               11.23     3_067.15     3_078.38       1.0000     0.000005        61.04
GPU-Exhaustive (self)                                11.23    47_290.08    47_301.31       1.0000     0.000005        61.04
---------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl353-np17 (query)                        7_371.83       684.32     8_056.15       0.9864     0.156242        62.95
IVF-GPU-nl353-np18 (query)                        7_371.83       717.76     8_089.60       0.9917     0.093745        62.95
IVF-GPU-nl353-np26 (query)                        7_371.83       903.45     8_275.28       1.0000     0.000005        62.95
IVF-GPU-nl353 (self)                              7_371.83    11_092.69    18_464.52       1.0000     0.000005        62.95
IVF-GPU-nl500-np22 (query)                       10_261.26       800.41    11_061.67       0.9848     0.145266        62.95
IVF-GPU-nl500-np25 (query)                       10_261.26       807.88    11_069.15       0.9962     0.036926        62.95
IVF-GPU-nl500-np31 (query)                       10_261.26       909.35    11_170.61       1.0000     0.000005        62.95
IVF-GPU-nl500 (self)                             10_261.26    10_332.74    20_594.01       1.0000     0.000005        62.95
IVF-GPU-nl707-np26 (query)                       14_403.05       814.71    15_217.77       0.9588     0.408463        62.95
IVF-GPU-nl707-np35 (query)                       14_403.05       929.08    15_332.13       0.9956     0.040794        62.95
IVF-GPU-nl707-np37 (query)                       14_403.05     1_019.88    15_422.93       0.9981     0.017132        62.95
IVF-GPU-nl707 (self)                             14_403.05    10_593.88    24_996.93       0.9983     0.016078        62.95
---------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

The results here are more favourable of the GPU acceleration. We go from ~170
seconds with exhaustive search on CPU to ~50 seconds on GPU; if using IVF, we
can reduce at the fastest settings the time from ~40 seconds on CPU to ~20 
seconds on GPU. This gives us a total acceleration of 
**170 seconds *(exhaustive on CPU)* to 20 seconds *(IVF on GPU)***, a `8.5x` 
acceleration while having a Recall 1.00. 

#### With 500k samples and 64 dimensions

Results are becoming even more pronounced with more cells and showing the
advantage of the GPU acceleration. 

<details>
<summary><b>CPU-IVF (larger dataset)</b>:</summary>
<pre><code>
===========================================================================================================================
Benchmark: 500k cells, 64D
===========================================================================================================================
Method                                          Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
---------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                   22.43    20_795.15    20_817.59       1.0000     0.000000       122.07
Exhaustive (self)                                    22.43   718_508.37   718_530.81       1.0000     0.000000       122.07
---------------------------------------------------------------------------------------------------------------------------
IVF-nl500-np22 (query)                           21_178.16     3_864.71    25_042.87       0.9862     0.123328       126.01
IVF-nl500-np25 (query)                           21_178.16     4_282.37    25_460.53       0.9956     0.039539       126.01
IVF-nl500-np31 (query)                           21_178.16     5_062.44    26_240.60       0.9997     0.003572       126.01
IVF-nl500 (self)                                 21_178.16   185_014.09   206_192.24       0.9996     0.003517       126.01
IVF-nl707-np26 (query)                           30_374.63     3_270.95    33_645.58       0.9666     0.281879       126.06
IVF-nl707-np35 (query)                           30_374.63     4_101.21    34_475.84       0.9962     0.020091       126.06
IVF-nl707-np37 (query)                           30_374.63     4_942.99    35_317.62       0.9982     0.007448       126.06
IVF-nl707 (self)                                 30_374.63   141_799.83   172_174.46       0.9981     0.007536       126.06
IVF-nl1000-np31 (query)                          42_728.75     2_516.44    45_245.19       0.9390     0.544258       126.14
IVF-nl1000-np44 (query)                          42_728.75     3_527.98    46_256.73       0.9898     0.070909       126.14
IVF-nl1000-np50 (query)                          42_728.75     3_996.27    46_725.02       0.9969     0.016513       126.14
IVF-nl1000 (self)                                42_728.75   121_630.25   164_358.99       0.9897     0.073181       126.14
---------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

<details>
<summary><b>GPU-IVF (larger dataset)</b>:</summary>
<pre><code>
===========================================================================================================================
Benchmark: 500k cells, 64D (CPU vs GPU Exhaustive vs IVF-GPU)
===========================================================================================================================
Method                                          Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
---------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                   21.22    22_582.87    22_604.09       1.0000     0.000000       122.07
Exhaustive (self)                                    21.22   679_876.98   679_898.20       1.0000     0.000000       122.07
---------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                               21.28     6_511.46     6_532.74       1.0000     0.000005       122.07
GPU-Exhaustive (self)                                21.28   201_904.86   201_926.14       1.0000     0.000005       122.07
---------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl500-np22 (query)                       21_104.98     1_184.90    22_289.88       0.9863     0.123052       125.89
IVF-GPU-nl500-np25 (query)                       21_104.98     1_220.08    22_325.06       0.9956     0.039545       125.89
IVF-GPU-nl500-np31 (query)                       21_104.98     1_461.72    22_566.70       0.9997     0.003578       125.89
IVF-GPU-nl500 (self)                             21_104.98    35_676.31    56_781.28       0.9996     0.003523       125.89
IVF-GPU-nl707-np26 (query)                       29_726.99     1_304.30    31_031.29       0.9666     0.281920       125.89
IVF-GPU-nl707-np35 (query)                       29_726.99     1_681.66    31_408.65       0.9962     0.020128       125.89
IVF-GPU-nl707-np37 (query)                       29_726.99     1_607.84    31_334.83       0.9981     0.007504       125.89
IVF-GPU-nl707 (self)                             29_726.99    35_138.29    64_865.28       0.9981     0.007536       125.89
IVF-GPU-nl1000-np31 (query)                      42_129.40     1_185.10    43_314.50       0.9390     0.545915       125.89
IVF-GPU-nl1000-np44 (query)                      42_129.40     1_443.55    43_572.96       0.9898     0.070747       125.89
IVF-GPU-nl1000-np50 (query)                      42_129.40     1_598.60    43_728.00       0.9968     0.017605       125.89
IVF-GPU-nl1000 (self)                            42_129.40    30_713.82    72_843.22       0.9896     0.073500       125.89
---------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

In this configuration, the exhaustive CPU to GPU already causes a massive 
reduction in the generation of the full kNN. From ~12 minutes to ~3 minutes. 
However, the true acceleleration comes with the IVF-GPU versions that reduces 
the full kNN generation to a minute.

#### High dimensionality

With even higher dimensionality, we can observe the advantage of the 
GPU-accelerated versions. Particularly, the difference in the exhaustive search 
is already very impressive with a 7x increase in querying speed. Basically, the 
more dimensions you are dealing with, the better the GPU acceleration works.

<details>
<summary><b>GPU with high dimensionality</b>:</summary>
<pre><code>
===========================================================================================================================
Benchmark: 150k cells, 128D (CPU vs GPU Exhaustive vs IVF-GPU)
===========================================================================================================================
Method                                          Build (ms)   Query (ms)   Total (ms)     Recall@k   Dist Error    Size (MB)
---------------------------------------------------------------------------------------------------------------------------
Exhaustive (query)                                   15.03    17_748.77    17_763.79       1.0000     0.000000        73.24
Exhaustive (self)                                    15.03   178_379.11   178_394.13       1.0000     0.000000        73.24
---------------------------------------------------------------------------------------------------------------------------
GPU-Exhaustive (query)                               16.21     2_745.67     2_761.87       1.0000     0.000003        73.24
GPU-Exhaustive (self)                                16.21    26_458.49    26_474.70       1.0000     0.000003        73.24
---------------------------------------------------------------------------------------------------------------------------
IVF-GPU-nl273-np13 (query)                       10_040.34       698.79    10_739.13       0.9934     0.025305        74.39
IVF-GPU-nl273-np16 (query)                       10_040.34       782.96    10_823.30       0.9984     0.006803        74.39
IVF-GPU-nl273-np23 (query)                       10_040.34     1_034.07    11_074.42       1.0000     0.000003        74.39
IVF-GPU-nl273 (self)                             10_040.34     7_166.68    17_207.02       1.0000     0.000003        74.39
IVF-GPU-nl387-np19 (query)                       14_199.61       787.51    14_987.12       0.9957     0.015579        74.39
IVF-GPU-nl387-np27 (query)                       14_199.61       977.26    15_176.87       0.9999     0.000498        74.39
IVF-GPU-nl387 (self)                             14_199.61     6_794.63    20_994.23       0.9999     0.000529        74.39
IVF-GPU-nl547-np23 (query)                       20_230.09       830.37    21_060.46       0.9925     0.024024        74.39
IVF-GPU-nl547-np27 (query)                       20_230.09       868.63    21_098.72       0.9971     0.008552        74.39
IVF-GPU-nl547-np33 (query)                       20_230.09     1_006.31    21_236.40       0.9996     0.001042        74.39
IVF-GPU-nl547 (self)                             20_230.09     6_934.27    27_164.36       0.9996     0.001054        74.39
---------------------------------------------------------------------------------------------------------------------------
</code></pre>
</details>

*All benchmarks were run on M1 Max MacBook Pro with 64 GB unified memory.*
*The GPU backend was the wgpu backend.*